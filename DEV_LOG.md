\# 📋 项目开发日志



\*\*项目名称：\*\* Spiro-Diffusion（多模态肺功能曲线重建）  

\*\*维护者：\*\* \[Ruiqi-Li-China]  

\*\*状态：\*\* 第二阶段（扩散模型训练）已完成  

\*\*最后更新：\*\* 2026-02-16



---



\## 📅 已完成的工作总结



\### Phase 1: 数据工程与多模态对齐  

\*\*目标：\*\* 构建一个高质量的数据集，将肺功能曲线与临床特征（如年龄、身高、性别等）关联。  

\- \*\*数据来源：\*\* NHANES 2011-2012（Cycle G）。  

\- \*\*执行操作：\*\*  

&nbsp;   - 下载了 `SPXRAW\_G`（原始曲线）、`DEMO\_G`（人口统计数据）、`BMX\_G`（身体测量数据）。  

&nbsp;   - 通过手动验证解决了 `XPT` 文件头损坏的问题。  

&nbsp;   - 实现了 `src/preprocess\_multimodal.py` 通过 `SEQN` 字段进行内连接（INNER JOIN）。  

&nbsp;   - 对所有曲线进行重采样，统一长度为 512 点（单位：L/s）。  

\- \*\*成果：\*\*  

&nbsp;   - 成功对齐了 \*\*36,873\*\* 位患者数据。  

&nbsp;   - 生成了 `metadata\_aligned.csv`（包含年龄、身高、性别等临床特征）。  

&nbsp;   - 生成了 `signals\_L512.npy`（标准化的 1D 曲线数据）。



\### Phase 1.2: 潜在表示学习（VQ-VAE）  

\*\*目标：\*\* 将高维信号压缩为离散的潜在代码（latent codes）。  

\- \*\*模型：\*\* 1D VQ-VAE（编码器 → 量化器 → 解码器）。  

\- \*\*训练：\*\*  

&nbsp;   - 输入为 `signals\_L512.npy`。  

&nbsp;   - 压缩比：512 个点 $\\to$ 64 个潜在令牌（latent tokens）。  

&nbsp;   - 使用脚本 `src/train\_vqvae.py`。  

\- \*\*成果：\*\* 模型训练完成并保存为 `checkpoints/vqvae\_phase1.pth`。



\### Phase 2: 条件潜在扩散模型（cLDM）  

\*\*目标：\*\* 基于患者的生物特征（如年龄、身高、性别）生成肺功能曲线。  

\- \*\*潜在表示生成：\*\*  

&nbsp;   - 通过运行 `src/prepare\_latents.py`，将所有 36,000 条信号转换为潜在向量（$64 \\times 128$）。  

&nbsp;   - 保存为 `latents.npy`（注意：约 1.2GB，不上传到 GitHub）。  

\- \*\*模型：\*\* 基于临床特征的 1D 条件 U-Net（使用时序嵌入与时序交叉注意力）。  

\- \*\*训练：\*\*  

&nbsp;   - 使用脚本 `src/train\_cldm.py`。  

&nbsp;   - 通过过滤缺失身高数据的 220 行解决了 `NaN Loss` 的问题。  

&nbsp;   - 损失值从 1.07 降低到约 0.15。  

\- \*\*成果：\*\* 模型保存为 `checkpoints/cldm\_phase2.pth`。



---



\## 📂 数据集清单



要重新生成结果，你需要确保 `data/` 文件夹包含以下文件：



| 文件名 | 描述 | 当前仓库状态 |

|--------|------|----------------|

| `metadata\_aligned.csv` | 对齐后的临床数据（年龄、身高、性别等） | ✅ 已上传 |

| `signals\_L512.npy` | 预处理后的 1D 曲线（长度为 512） | ✅ 已上传 |

| `SPX\_G.xpt` | 原始肺功能数据（未压缩） | ✅ 已上传 |

| `latents.npy` | VQ-VAE 编码后的潜在表示 | ❌ 过大（本地生成） |



---



\## 🚀 如何继续工作？



1\. \*\*如果丢失了 `latents.npy`，可以重新生成：\*\*  

&nbsp;  使用以下命令从 `signals\_L512.npy` 重新生成潜在表示：

&nbsp;  ```bash

&nbsp;  python src/prepare\_latents.py



